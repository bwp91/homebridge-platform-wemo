<p class="text-center">
  <img src="https://user-images.githubusercontent.com/43026681/100233760-13a66e80-2f22-11eb-81f1-81e0efdb16e8.png" alt="homebridge-platform-wemo logo" style="width: 60%;">
</p>
<div id="pageIntro" class="text-center" style="display: none;">
  <p class="lead">Thank you for installing <strong>homebridge-platform-wemo</strong></p>
  <p>Your Wemo devices will be automatically discovered</p>
  <button type="button" class="btn btn-primary" id="introContinue">Continue &rarr;</button>
</div>
<div id="menuWrapper" class="btn-group w-100 mb-0" role="group" aria-label="UI Menu" style="display: none;">
  <button type="button" class="btn btn-primary ml-0" id="menuSettings">Settings</button>
  <button type="button" class="btn btn-primary" id="menuDevices">My Devices</button>
  <button type="button" class="btn btn-primary mr-0" id="menuHome">Support</button>
</div>
<div id="disabledBanner" class="alert alert-secondary mb-0 mt-3" role="alert" style="display: none;">
  Plugin is currently disabled <button id="disabledEnable" type="button" class="btn btn-link p-0 m-0 float-right">Enable</button>
</div>
<div id="pageDevices" class="mt-4" style="display: none;">
  <div id="deviceInfo">
    <form>
      <div class="form-group">
        <select class="form-control" id="deviceSelect"></select>
      </div>
    </form>
    <table class="table w-100" id="deviceTable">
      <thead>
        <tr class="table-active">
          <th scope="col" style="width: 40%;">Device Name</th>
          <th scope="col" style="width: 60%;" id="displayName"></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th scope="row">Controllable</th>
          <td id="controllable"></td>
        </tr>
        <tr>
          <th scope="row">Serial Number</th>
          <td id="serialNumber"></td>
        </tr>
        <tr>
          <th scope="row">MAC Address</th>
          <td id="macAddress"></td>
        </tr>
        <tr>
          <th scope="row">IP Address</th>
          <td id="ipAddress"></td>
        </tr>
        <tr>
          <th scope="row">UPnP Info</th>
          <td id="upnpInfo"></td>
        </tr>
        <tr>
          <td colspan="2" style="text-align: center" id="imgIcon"></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<div id="pageSupport" class="mt-4" style="display: none;">
  <p class="text-center lead">Thank you for using <strong>homebridge-platform-wemo</strong></p>
  <p class="text-center">The links below will take you to our GitHub wiki</p>
  <h4>Features</h4>
  <ul>
  <li><a href="https://github.com/bwp91/homebridge-platform-wemo/wiki/Supported-Devices" target="_blank">Supported Devices</a></li>
  <li><a href="https://github.com/bwp91/homebridge-platform-wemo/wiki/Beta-Version" target="_blank">Beta Version</a></li>
  </ul>
  <h4>How-to Guides</h4>
  <ul>
  <li><a href="https://github.com/bwp91/homebridge-platform-wemo/wiki/How-to-remove-an-accessory-from-the-cache" target="_blank">How to remove an accessory from the cache</a></li>
  <li><a href="https://github.com/bwp91/homebridge-platform-wemo/wiki/How-to-update-node" target="_blank">How to update node</a></li>
  </ul>
  <h4>About</h4>
  <ul>
  <li><a href="https://github.com/sponsors/bwp91" target="_blank">About Me</a></li>
  <li><a href="https://github.com/bwp91/homebridge-platform-wemo/releases" target="_blank">Changelog</a></li>
  <li><a href="https://github.com/bwp91/homebridge-platform-wemo/issues/new/choose" target="_blank">Support Request</a></li>
  </ul>
  <h4>Credits</h4>
  <ul>
  <li>To the creator of this plugin: <a href="https://github.com/rudders" target="_blank">@rudders</a>, and to <a href="https://github.com/devbobo" target="_blank">@devbobo</a> for his contributions.</li>
  <li>To the creator of <a href="https://github.com/timonreinhard/wemo-client" target="_blank">wemo-client</a> (which is now contained within this plugin): <a href="https://github.com/timonreinhard" target="_blank">@timonreinhard</a>.</li>
  <li>To <a href="http://www.hardill.me.uk/wordpress/tag/wemo/" target="_blank">Ben Hardill</a> for his research on Wemo devices.</li>
  <li>To the creators/contributors of <a href="https://homebridge.io" target="_blank">Homebridge</a> who make this plugin possible.</li>
  <li>To all users who have helped/tested to enable functionality for new devices.</li>
  </ul>
  <h4>Disclaimer</h4>
  <ul>
  <li>I am in no way affiliated with Belkin/Wemo and this plugin is a personal project that I maintain in my free time.</li>
  </ul>
</div>
<script>
  (async () => {
    try {
      const currentConfig = await homebridge.getPluginConfig()
      showIntro = () => {
        const introContinue = document.getElementById('introContinue')
        introContinue.addEventListener('click', () => {
          homebridge.showSpinner()
          document.getElementById('pageIntro').style.display = 'none'
          document.getElementById('menuWrapper').style.display = 'inline-flex'
          showSettings()
          homebridge.hideSpinner()
        })
        document.getElementById('pageIntro').style.display = 'block'
      }
      showDevices = async () => {
        homebridge.showSpinner()
        homebridge.hideSchemaForm()
        document.getElementById('menuHome').classList.remove('btn-elegant')
        document.getElementById('menuHome').classList.add('btn-primary')
        document.getElementById('menuDevices').classList.add('btn-elegant')
        document.getElementById('menuDevices').classList.remove('btn-primary')
        document.getElementById('menuSettings').classList.remove('btn-elegant')
        document.getElementById('menuSettings').classList.add('btn-primary')
        document.getElementById('pageSupport').style.display = 'none'
        document.getElementById('pageDevices').style.display = 'block'
        const cachedAccessories = await homebridge.request('/getCachedAccessories')
        const deviceSelect = document.getElementById('deviceSelect')
        deviceSelect.innerHTML = ''
        cachedAccessories.forEach(a => {
          const option = document.createElement('option')
          option.text = a.displayName
          option.value = a.context.serialNumber
          deviceSelect.add(option)
        })
        showDeviceInfo = async serialNumber => {
          homebridge.showSpinner()
          const selectedAccessory = cachedAccessories.find(x => x.context.serialNumber === serialNumber)
          console.log(selectedAccessory)
          document.getElementById('displayName').innerHTML = selectedAccessory.displayName
          document.getElementById('controllable').innerHTML = selectedAccessory.context.controllable
            ? 'Yes'
            : 'No'
          document.getElementById('serialNumber').innerHTML = selectedAccessory.context.serialNumber
          document.getElementById('ipAddress').innerHTML = selectedAccessory.context.ipAddress
          document.getElementById('upnpInfo').innerHTML =
            '<a href="http://' + selectedAccessory.context.ipAddress + ':' + selectedAccessory.context.port + '/setup.xml" target="_blank" style="color: #fff;">'
            + 'http://' + selectedAccessory.context.ipAddress + ':' + selectedAccessory.context.port + '/setup.xml'
            + '</a>'
          document.getElementById('macAddress').innerHTML = selectedAccessory.context.macAddress
          document.getElementById('imgIcon').innerHTML = selectedAccessory.context.icon
            ? '<img src="http://' + selectedAccessory.context.ipAddress + ':' + selectedAccessory.context.port + '/' + selectedAccessory.context.icon + '" style="width: 100px;">'
            : ''
          document.getElementById('deviceTable').style.display = 'inline-table'
          homebridge.hideSpinner()
        }
        deviceSelect.addEventListener('change', event => showDeviceInfo(event.target.value))
        if (cachedAccessories.length > 0) {
          showDeviceInfo(cachedAccessories[0].context.serialNumber)
        } else {
          const option = document.createElement('option')
          option.text = 'No Devices'
          deviceSelect.add(option)
          deviceSelect.disabled = true
        }
        homebridge.hideSpinner()
      }
      showSupport = () => {
        homebridge.showSpinner()
        homebridge.hideSchemaForm()
        document.getElementById('menuHome').classList.add('btn-elegant')
        document.getElementById('menuHome').classList.remove('btn-primary')
        document.getElementById('menuDevices').classList.remove('btn-elegant')
        document.getElementById('menuDevices').classList.add('btn-primary')
        document.getElementById('menuSettings').classList.remove('btn-elegant')
        document.getElementById('menuSettings').classList.add('btn-primary')
        document.getElementById('pageSupport').style.display = 'block'
        document.getElementById('pageDevices').style.display = 'none'
        homebridge.hideSpinner()
      }
      showSettings = () => {
        homebridge.showSpinner()
        document.getElementById('menuHome').classList.remove('btn-elegant')
        document.getElementById('menuHome').classList.add('btn-primary')
        document.getElementById('menuDevices').classList.remove('btn-elegant')
        document.getElementById('menuDevices').classList.add('btn-primary')
        document.getElementById('menuSettings').classList.add('btn-elegant')
        document.getElementById('menuSettings').classList.remove('btn-primary')
        document.getElementById('pageSupport').style.display = 'none'
        document.getElementById('pageDevices').style.display = 'none'
        homebridge.showSchemaForm()
        homebridge.hideSpinner()
      }
      showDisabledBanner = () => {
        document.getElementById('disabledBanner').style.display = 'block'
      }
      enablePlugin = async () => {
        homebridge.showSpinner()
        document.getElementById('disabledBanner').style.display = 'none'
        currentConfig[0].disablePlugin = false
        await homebridge.updatePluginConfig(currentConfig)
        await homebridge.savePluginConfig()
        homebridge.hideSpinner()
      }
      menuHome.addEventListener('click', () => showSupport())
      menuDevices.addEventListener('click', () => showDevices())
      menuSettings.addEventListener('click', () => showSettings())
      disabledEnable.addEventListener('click', () => enablePlugin())
      if (currentConfig.length) {
        document.getElementById('menuWrapper').style.display = 'inline-flex'
        showSettings()
        if (currentConfig[0].disablePlugin) {
          showDisabledBanner()
        }
      } else {
        currentConfig.push({ name: 'Wemo' })
        await homebridge.updatePluginConfig(currentConfig)
        showIntro()
      }
      
    } catch (err) {
      homebridge.toast.error(err.message, 'Error')
    } finally {
      homebridge.hideSpinner()
    }
  })()
</script>